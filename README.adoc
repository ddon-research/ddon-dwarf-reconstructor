= DDON DWARF Reconstructor

Reconstructs C++ header files from DWARF debug symbols in PS4 ELF files using pyelftools.

== Features

* **pyelftools integration**: Direct use of pyelftools DWARF parser without reinventing APIs
* **Type resolution**: Resolves complex C++ types including references, pointers, and const qualifiers
* **C++ structure reconstruction**: Generates class definitions with inheritance, virtual methods, and member variables
* **PS4 ELF compatibility**: Handles PS4-specific ELF format variations

== Design Philosophy

This project uses pyelftools directly without reinventing DWARF parsing. We reuse their established API and data structures (`DWARFInfo`, `CompilationUnit`, `DIE`) rather than creating custom abstractions. This approach provides:

== Requirements

* Python 3.13+
* pyelftools
* ELF file with DWARF debug information

== Installation

[source,bash]
----
# Using uv (recommended)
uv sync
----

== Usage

=== Command Line Interface

[source,bash]
----
# Generate header (quiet mode - default)
python main.py resources/DDOORBIS.elf --generate MtObject

# Generate header (verbose mode with debug logs)
python main.py resources/DDOORBIS.elf --generate MtObject --verbose

# Custom output directory
python main.py resources/DDOORBIS.elf --generate MtObject -o headers/
----

=== Using .env Configuration

[source,bash]
----
# Create .env file
echo "ELF_FILE_PATH=resources/DDOORBIS.elf" > .env

# Now you can omit the ELF path
python main.py --generate MtObject
----

=== Output

* **Headers**: Generated in `output/` directory as `<symbol>.h`
* **Logs**: Timestamped files in `logs/` directory (e.g., `ddon_reconstructor_20251007_143052.log`)

[source,bash]
----
# Example output structure
output/
  MtObject.h
logs/
  ddon_reconstructor_20251007_143052.log
----

=== Verbose vs. Quiet Mode

**Quiet Mode (default)**:
[source]
----
INFO: Generating header for: MtObject
INFO: Found MtObject in CU at offset 0xc9d
INFO: [SUCCESS] Generated: output/MtObject.h
INFO: Size: 784 bytes
----

**Verbose Mode (`--verbose`)**:
[source]
----
DEBUG: ELF file: resources/DDOORBIS.elf
DEBUG: Output directory: output
INFO: Generating header for: MtObject
INFO: Found MtObject in CU at offset 0xc9d
DEBUG: DIE DW_TAG_subprogram has no DW_AT_type attribute
INFO: [SUCCESS] Generated: output/MtObject.h
DEBUG: Preview (first 30 lines):
... (header content preview)
DEBUG: ============================================================
----

== Architecture

[source]
----
src/ddon_dwarf_reconstructor/
├── core/           # DWARF constants and enums
│   └── models.py          # DWTag, DWAccessibility, DWVirtuality enums
├── generators/     # C++ header generation
│   └── native_generator.py  # Native pyelftools implementation
├── config/         # Configuration management
│   └── config.py          # Config with .env support
├── utils/          # Utilities
│   ├── logger.py          # Centralized logging
│   └── elf_patches.py     # PS4 ELF compatibility patches
└── main.py         # CLI entry point
----

== Testing

The project includes a comprehensive testing infrastructure with xUnit reporting, code coverage, and automated CI/CD.

=== Quick Testing

[source,bash]
----
# Unit tests (fast, mocked - recommended for development)
uv run pytest -m unit

# All tests  
uv run pytest

# With coverage report
uv run pytest -m unit --cov-report=html
# Open htmlcov/index.html for detailed coverage

# Using Makefile shortcuts
make test          # Unit tests
make coverage      # HTML coverage report
make ci           # Full CI simulation
----

=== Test Categories

* **Unit Tests** (`@pytest.mark.unit`): Fast mocked tests (~0.1s, 22 tests)
* **Integration Tests** (`@pytest.mark.integration`): Real ELF file tests (~3s, 2 tests)  
* **Slow Tests** (`@pytest.mark.slow`): Long-running tests (skip with `-m "not slow"`)

=== CI/CD Pipeline

* **GitHub Actions**: Automated testing on push to `main` and PRs
* **Python 3.13**: Latest Python version with ubuntu-latest
* **Coverage Reporting**: Codecov integration with 30% minimum threshold
* **Quality Gates**: Ruff linting, MyPy type checking, test coverage

=== Generated Reports

* **JUnit XML** (`test-results.xml`): xUnit-style test results for CI systems
* **Coverage XML** (`coverage.xml`): Machine-readable coverage data  
* **HTML Coverage** (`htmlcov/`): Interactive line-by-line coverage visualization

See link:docs/TESTING.md[docs/TESTING.md] for comprehensive testing documentation.

== Development

[source,bash]
----
# Install with development dependencies
uv sync

# Run type checking
uv run mypy src/

# Run linting
uv run ruff check src/

# Format code
uv run ruff format src/
----

== Configuration Priority

Configuration is loaded in this order (later overrides earlier):

1. `.env` file
2. Environment variables
3. Command-line arguments

Example:
[source,bash]
----
# .env file
ELF_FILE_PATH=resources/DDOORBIS.elf
OUTPUT_DIR=output
VERBOSE=false

# Override with CLI
python main.py --verbose  # Uses .env ELF path but enables verbose
----

== Sample Output

Generated `MtObject.h`:
[source,cpp]
----
class MtObject
{
public:
    virtual ~MtObject();
    virtual MtUI* createUI();
    virtual bool isEnableInstance();
    virtual void createProperty();
    virtual const MtDTI& getDTI();
public:
    void* _vptr$MtObject;  // offset: 0x0

    // Static members
    static const u32 INITIAL_ALLOCATOR = 0;
    static MyDTI DTI;
};
----
